---
title: "Phoracantha recurva"
output: html_notebook
---

# librerías
```{r}
library(tidyverse)
library(rgbif)
library(sf)
library(terra)
library(tmap)
library(kewr)
library(CoordinateCleaner)
library(BIEN)

```


# Datos de registro de _Phoracantha_
## Species key
```{r}
sp_info <- rgbif::name_backbone('Phoracantha recurva')

glimpse(sp_info) # Función de tidyverse

species_key <- sp_info$speciesKey
```

## Download
```{r}
gbif_download <- occ_download(
  pred("taxonKey", species_key),
  pred("hasCoordinate", TRUE), # con coordenadas
  pred("hasGeospatialIssue", FALSE), # sin problemas espaciales
  format = "SIMPLE_CSV")

# Esperar a que esté lista (pueden ser hasta 30 minutos)
occ_download_wait(gbif_download)
```

# Cargar datos

```{r}
gbif_result <-  occ_download_import(key = '0001271-241107131044228')
```

## Referencia de la descarga

```{r}
occ_download_meta(key = '0001271-241107131044228') %>% gbif_citation()
```

# Limpiar los datos con `CoordinateCleaner`

```{r}

gbif_clean <- gbif_result %>% 
  cc_dupl() %>% # duplicados
  cc_cap()  %>% # capitales
  cc_cen() %>% # centroides de países
  cc_equ() %>% # coordenadas iguales (ejemplo: -1,-1)
  cc_sea() %>% # en el mar
  cc_val() %>% # coordenadas inválidas 
  cc_zero() 
  
```

## Resultado

```{r}
glimpse(gbif_clean)
```

## Visualizar los datos

```{r}

tmap_mode('view') # imagen estática

# convertir a objeto espacial
m1 <- st_as_sf(gbif_clean, coords = c('decimalLongitude', 'decimalLatitude'), 
         crs = 4326)
  # Plotear
  tm_shape(m1) + tm_dots( 'basisOfRecord',size = 0.25)
  

```

# Seleccionar datos de Australia
```{r}
native <- gbif_clean %>% 
  filter(countryCode == 'AU' & basisOfRecord == 'PRESERVED_SPECIMEN')   %>% 
  select(species, decimalLongitude, decimalLatitude)
```


# Eucaliptos

Distribución de las plantas hospederas basado en el _World Geographical Scheme for Recording Plant Distributions_, utilizando el nivel. Se obtiene a partir de los datos presentes en la base de datos de _Plants of the world_ através del paquete `kewr`.

Published for the International Working Group on Taxonomic Databases For Plant Sciences (TDWG). Downloaded from [here](%5B)<https://github.com/tdwg/wgsrpd/tree/master>.

## World Geographical Scheme for Recording Plant Distributions
```{r}
tdwg <- st_read('data/wgsrpd-master/level3')

```

## Checar nombres de hospederos usando el backbone de GBIF y Kew Names Matching Service.
```{r}
eucalyptus_ipni<- name_backbone_checklist(c('Eucalyptus camaldulensis Dehnhardt',
                          'Eucalyptuscinerea F. Müller ex Bentham',
                          'Eucalyptus citriodora Hooker',
                          'Eucalyptus cloeziana F. Müller',
                          'Eucalyptus drepanophylla F. Müller ex Bentham',
                          'Eucalyptus globulus Labillardiére',
                          'Eucalyptus grandis W. Hill ex Maiden',
                          'Eucalyptus intermedia R. T. Baker',
                          'Eucalyptus maculata Hooker',
                          'Eucalyptus nova-anglica Deane & Maiden',
                          'Eucalyptus ovata Labillardière',
                          'Eucalyptus robusta Smith',
                          'Eucalyptus saligna Smith',
                          'Eucalyptus sideroxylon Cunnigham ex Woolls',
                          'Eucalyptus tereticornis Smith',
                          'Eucalyptus viminalis Labillardière')) %>%
  pull(species) %>% kewr::match_knms() %>% tidy() 
```

## Función para obtener los mapas

```{r}
x<-'593453-1'

get_distribution <- function(x){
  res_powo <- lookup_powo(x, distribution = T) %>% tidy() %>%
    select(distribution) %>%
    unnest(cols = distribution)
  cat(paste0(x,'\n'))
  
  if('introduced' %in% names(res_powo)){
    intro <- res_powo %>% 
    select(introduced) %>% unnest(cols = introduced) %>%
    select(tdwgCode) %>% mutate(presence = 'introduced')
    
    distribution <-res_powo %>% 
      select(natives) %>% unnest(cols = natives) %>%
      select(tdwgCode)%>% mutate(presence = 'native') %>%
      bind_rows(intro) %>% rename(LEVEL3_COD = tdwgCode)}else{
      
        cat('\nnot introduced anywhere\n')    
      distribution <-res_powo %>%
          select(natives) %>% unnest(cols = natives) %>%
          select(tdwgCode)%>% mutate(presence = 'native') %>%
          rename(LEVEL3_COD = tdwgCode)
    }
  
  
  res_sf <- eucalyptus_ipni %>% filter(ipni_id == x) %>%
    cbind(tdwg, .) %>%
    filter(LEVEL3_COD %in% distribution$LEVEL3_COD) %>%
    left_join(., distribution) 
  
  return(res_sf)}


distr_res <- eucalyptus_ipni %>% filter(ipni_id != '593453-1') %>%
  pull(ipni_id) %>% lapply(get_distribution)



distr_res %>% bind_rows() %>%
  select(LEVEL3_COD, matched_record, presence) %>%
  mutate(matched_record = word(matched_record, start = 1,end = 2)) %>%
  group_by(LEVEL3_COD, presence, geometry) %>% mutate(rich = n_distinct(matched_record)) %>% mutate(pres = 1) %>%
  pivot_wider(id_cols = c(LEVEL3_COD, presence, geometry, rich), names_from = matched_record, values_from = pres) 

```




```{r}
tmap_mode('plot')
eucalyptus_sf <- BIEN_ranges_load_species(eucalyptus_ipni$submitted)

qtm(eucalyptus_sf) +tm_facets_wrap('species')
```

